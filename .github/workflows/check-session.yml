name: æ£€æŸ¥ Session æœ‰æ•ˆæ€§

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ 9:00 æ£€æŸ¥ä¸€æ¬¡ï¼ˆUTC 1:00ï¼‰
    - cron: '0 1 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: read
  issues: write

jobs:
  check-session:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install requests
      
      - name: æ£€æŸ¥ Session æœ‰æ•ˆæ€§
        id: check-session
        continue-on-error: true
        env:
          ANYROUTER_ACCOUNTS: ${{ secrets.ANYROUTER_ACCOUNTS }}
        run: |
          python check_session_expiry.py

      - name: åˆ›å»º Issue é€šçŸ¥ï¼ˆå¦‚æœæ£€æŸ¥å¤±è´¥ï¼‰
        if: steps.check-session.outcome == 'failure'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'âš ï¸ Session å³å°†è¿‡æœŸæé†’',
              body: `## æ£€æŸ¥æ—¶é—´
              ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}

              ## âš ï¸ è­¦å‘Š
              éƒ¨åˆ†è´¦å·çš„ Session å·²è¿‡æœŸæˆ–å³å°†è¿‡æœŸï¼

              ## ğŸ”§ å¤„ç†æ–¹æ³•
              1. è®¿é—®ä»¥ä¸‹ç½‘ç«™é‡æ–°ç™»å½•ï¼š
                 - AgentRouter: https://agentrouter.org/oauth
                 - AnyRouter: https://anyrouter.top/oauth

              2. ä½¿ç”¨ F12 è·å–æ–°çš„ session cookie

              3. æ›´æ–° GitHub Secrets ä¸­çš„ ANYROUTER_ACCOUNTS

              ## ğŸ“‹ è¯¦ç»†æ—¥å¿—
              è¯·æŸ¥çœ‹ Actions è¿è¡Œæ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯ã€‚
              `,
              labels: ['session-expiry', 'notification']
            })

      - name: æ˜¾ç¤ºæ£€æŸ¥ç»“æœ
        if: always()
        run: |
          if [ "${{ steps.check-session.outcome }}" == "failure" ]; then
            echo "âš ï¸ Session æ£€æŸ¥å¤±è´¥ï¼è¯·æŸ¥çœ‹ä¸Šé¢çš„æ—¥å¿—äº†è§£è¯¦æƒ…ã€‚"
            echo ""
            echo "ğŸ”§ å¤„ç†æ–¹æ³•ï¼š"
            echo "1. è®¿é—® https://agentrouter.org/oauth æˆ– https://anyrouter.top/oauth é‡æ–°ç™»å½•"
            echo "2. ä½¿ç”¨ F12 è·å–æ–°çš„ session cookie"
            echo "3. æ›´æ–° GitHub Secrets ä¸­çš„ ANYROUTER_ACCOUNTS"
          else
            echo "âœ… æ‰€æœ‰è´¦å· Session å‡æœ‰æ•ˆï¼"
          fi
