name: 检查 Session 有效性

on:
  schedule:
    # 每天北京时间 9:00 检查一次（UTC 1:00）
    - cron: '0 1 * * *'
  workflow_dispatch:  # 允许手动触发

jobs:
  check-session:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout 代码
        uses: actions/checkout@v4
      
      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: 安装依赖
        run: |
          pip install requests
      
      - name: 检查 Session 有效性
        env:
          ANYROUTER_ACCOUNTS: ${{ secrets.ANYROUTER_ACCOUNTS }}
        run: |
          python check_session_expiry.py "$ANYROUTER_ACCOUNTS"
      
      - name: 发送通知（如果检查失败）
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '⚠️ Session 即将过期提醒',
              body: `## 检查时间
              ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}
              
              ## ⚠️ 警告
              部分账号的 Session 已过期或即将过期！
              
              ## 🔧 处理方法
              1. 访问以下网站重新登录：
                 - AgentRouter: https://agentrouter.org/oauth
                 - AnyRouter: https://anyrouter.top/oauth
              
              2. 使用 F12 获取新的 session cookie
              
              3. 更新 GitHub Secrets 中的 ANYROUTER_ACCOUNTS
              
              ## 📋 详细日志
              请查看 Actions 运行日志获取详细信息。
              `,
              labels: ['session-expiry', 'notification']
            })
